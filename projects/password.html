<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Password Generator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles for a better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            /* Gradient background for a more premium feel */
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%); /* Slightly softer dark gradient */
        }
        /* Custom slider track */
        input[type="range"]::-webkit-slider-runnable-track {
            background: #4b5563; /* gray-600 */
            height: 6px; /* Slightly thicker track */
            border-radius: 9999px;
        }
        input[type="range"]::-moz-range-track {
            background: #4b5563; /* gray-600 */
            height: 6px;
            border-radius: 9999px;
        }
        /* Custom slider thumb */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px; /* Slightly larger thumb */
            height: 24px;
            background: #6366f1; /* indigo-500 */
            border-radius: 50%;
            cursor: pointer;
            margin-top: -9px; /* Adjust to center with thicker track */
            border: 3px solid #e5e7eb; /* gray-200, thicker border */
            transition: background 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #6366f1; /* indigo-500 */
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #e5e7eb; /* gray-200 */
            transition: background 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            background: #4f46e5; /* indigo-600 */
            transform: scale(1.1); /* Pop effect on active */
        }
        input[type="range"]:active::-moz-range-thumb {
            background: #4f46e5; /* indigo-600 */
            transform: scale(1.1);
        }

        /* Toast Notification Animations */
        .toast {
            visibility: hidden;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, visibility 0.3s ease-out, transform 0.3s ease-out;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transform: translateY(0);
        }

        /* Password Display Animation */
        @keyframes password-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .password-animate {
            animation: password-fade-in 0.3s ease-out;
        }

        /* Shake Animation for validation errors */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); } /* More pronounced shake */
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
            transform: translate3d(0, 0, 0);
            backface-visibility: hidden;
            perspective: 1000px;
        }

        /* Password Strength Indicator Colors */
        .strength-bar {
            height: 10px; /* Slightly taller strength bar */
            border-radius: 5px;
            transition: width 0.4s ease-out, background-color 0.4s ease-out; /* Slower transition */
        }
        /* Adjusted colors for better visual progression */
        .strength-0 { width: 0%; background-color: #ef4444; /* red-500 */ }
        .strength-1 { width: 25%; background-color: #f97316; /* orange-500 */ }
        .strength-2 { width: 50%; background-color: #facc15; /* yellow-400 */ }
        .strength-3 { width: 75%; background-color: #22c55e; /* green-500 */ }
        .strength-4 { width: 100%; background-color: #10b981; /* emerald-500 */ }

        /* Checkbox/Radio button animation */
        input[type="checkbox"] {
            transition: transform 0.15s ease-out;
        }
        input[type="checkbox"]:checked {
            transform: scale(1.1);
        }
        input[type="checkbox"]:active {
            transform: scale(0.9);
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md">
        <h1 class="text-4xl font-extrabold text-center mb-2 text-white drop-shadow-lg">Advanced Password Generator</h1>
        <p class="text-center text-gray-300 mb-8 text-lg">Craft secure and unique passwords tailored for you.</p>

        <!-- Password Display -->
        <div class="bg-gray-800 rounded-xl p-5 mb-4 flex flex-col shadow-lg border border-gray-700">
            <div class="flex items-center justify-between mb-3">
                <span id="password-display" class="text-2xl font-mono truncate pr-4 break-all text-indigo-300"></span>
                <button id="copy-button" class="bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-bold py-2.5 px-5 rounded-lg transition-all duration-200 flex items-center shadow-md transform active:scale-95 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M8 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" />
                        <path d="M6 3a2 2 0 00-2 2v11a2 2 0 002 2h8a2 2 0 002-2V5a2 2 0 00-2-2 3 3 0 01-3 3H9a3 3 0 01-3-3z" />
                    </svg>
                    Copy
                </button>
            </div>
            <!-- Password Strength Indicator -->
            <div class="w-full bg-gray-700 rounded-full overflow-hidden">
                <div id="strength-bar" class="strength-bar strength-0"></div>
            </div>
            <p id="strength-text" class="text-right text-sm mt-2 text-gray-400 font-medium">Strength: N/A</p>
        </div>

        <!-- Settings Container -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg space-y-7 border border-gray-700">
            
            <!-- Password Length -->
            <div>
                <label for="length-slider" class="flex justify-between items-center text-lg font-semibold text-gray-300 mb-2">
                    Password Length
                    <span id="length-value" class="text-indigo-400 font-bold text-2xl">16</span>
                </label>
                <input id="length-slider" type="range" min="4" max="40" value="16" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer mt-2">
            </div>

            <!-- Generation Mode -->
            <div>
                <label class="text-lg font-semibold text-gray-300 mb-2">Generation Mode</label>
                <div class="flex gap-4 mt-2">
                    <button id="mode-random" class="flex-1 bg-indigo-600 text-white py-3 rounded-lg transition-all duration-200 shadow-md hover:bg-indigo-700 active:bg-indigo-800 transform active:scale-95 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-75">Random</button>
                    <button id="mode-memorable" class="flex-1 bg-gray-600 hover:bg-gray-500 active:bg-gray-700 text-white py-3 rounded-lg transition-all duration-200 shadow-md transform active:scale-95 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">Memorable</button>
                </div>
            </div>

            <!-- Random Character Options -->
            <fieldset id="random-options" class="space-y-4">
                <legend class="text-xl font-semibold text-gray-300 border-t border-gray-700 pt-5 mt-4">Character Sets</legend>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                        <input id="include-uppercase" type="checkbox" checked class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                        <label for="include-uppercase" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Include Uppercase (A-Z)</label>
                    </div>
                    <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                        <input id="include-lowercase" type="checkbox" checked class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                        <label for="include-lowercase" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Include Lowercase (a-z)</label>
                    </div>
                    <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                        <input id="include-numbers" type="checkbox" checked class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                        <label for="include-numbers" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Include Numbers (0-9)</label>
                    </div>
                    <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                        <input id="include-symbols" type="checkbox" checked class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                        <label for="include-symbols" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Include Symbols (!@#$)</label>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                        <input id="exclude-similar" type="checkbox" class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                        <label for="exclude-similar" class="ml-3 text-sm font-medium text-gray-300 cursor-pointer">Exclude Similar (i,l,1,o,0,O)</label>
                    </div>
                    <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                        <input id="exclude-ambiguous" type="checkbox" class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                        <label for="exclude-ambiguous" class="ml-3 text-sm font-medium text-gray-300 cursor-pointer">Exclude Ambiguous ({}[]/\\'"`) </label>
                    </div>
                </div>
            </fieldset>

            <!-- Memorable Options -->
            <fieldset id="memorable-options" class="hidden space-y-4">
                <legend class="text-xl font-semibold text-gray-300 border-t border-gray-700 pt-5 mt-4">Memorable Options</legend>
                <div>
                    <label for="word-count-slider" class="flex justify-between items-center text-base font-medium text-gray-300 mb-2">
                        Word Count
                        <span id="word-count-value" class="text-indigo-400 font-bold text-xl">3</span>
                    </label>
                    <input id="word-count-slider" type="range" min="2" max="5" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer mt-2">
                </div>
                <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                    <input id="memorable-leetspeak" type="checkbox" class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                    <label for="memorable-leetspeak" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Use "Leet" Speak (e.g., e &#8594; 3)</label>
                </div>
                <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                    <input id="memorable-random-number" type="checkbox" checked class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                    <label for="memorable-random-number" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Include Random Number (e.g., 123)</label>
                </div>
                <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                    <input id="memorable-random-capitalization" type="checkbox" checked class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                    <label for="memorable-random-capitalization" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Random Capitalization (e.g., WoRd)</label>
                </div>
                <div class="flex items-center bg-gray-700 p-3.5 rounded-lg border border-gray-600">
                    <input id="memorable-include-year" type="checkbox" class="w-5 h-5 text-indigo-500 bg-gray-600 border-gray-500 rounded focus:ring-indigo-600 cursor-pointer">
                    <label for="memorable-include-year" class="ml-3 text-base font-medium text-gray-300 cursor-pointer">Include Random Year (e.g., 2023)</label>
                </div>
            </fieldset>

            <!-- Generate Button -->
            <button id="generate-button" class="w-full bg-green-600 hover:bg-green-700 active:bg-green-800 text-white font-bold py-3.5 px-6 rounded-lg text-xl transition-all duration-200 flex items-center justify-center shadow-lg transform active:scale-98 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-75">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6V4m0 16v-2m0-10v2M6 12H4m16 0h-2m-10 0h2m-2 4h2m-2-8h2M8 6V4m8 16v-2m-8-2h2m-2-4h2" />
                </svg>
                Generate Password
            </button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast fixed bottom-5 right-5 bg-indigo-600 text-white py-2.5 px-5 rounded-lg shadow-xl text-base">
        Password copied to clipboard!
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element References ---
            const passwordDisplay = document.getElementById('password-display');
            const lengthSlider = document.getElementById('length-slider');
            const lengthValue = document.getElementById('length-value');
            const generateButton = document.getElementById('generate-button');
            const copyButton = document.getElementById('copy-button');
            const toast = document.getElementById('toast');
            const strengthBar = document.getElementById('strength-bar');
            const strengthText = document.getElementById('strength-text');
            
            const modeRandomBtn = document.getElementById('mode-random');
            const modeMemorableBtn = document.getElementById('mode-memorable');
            const randomOptions = document.getElementById('random-options');
            const memorableOptions = document.getElementById('memorable-options');
            
            const includeUppercase = document.getElementById('include-uppercase');
            const includeLowercase = document.getElementById('include-lowercase');
            const includeNumbers = document.getElementById('include-numbers');
            const includeSymbols = document.getElementById('include-symbols');
            const excludeSimilar = document.getElementById('exclude-similar');
            const excludeAmbiguous = document.getElementById('exclude-ambiguous');
            // Array of all character set checkboxes for easier iteration
            const characterCheckboxes = [includeUppercase, includeLowercase, includeNumbers, includeSymbols];

            const wordCountSlider = document.getElementById('word-count-slider');
            const wordCountValue = document.getElementById('word-count-value');
            const useLeetspeak = document.getElementById('memorable-leetspeak');
            const includeMemorableNumber = document.getElementById('memorable-random-number');
            const randomCapitalization = document.getElementById('memorable-random-capitalization');
            const includeMemorableYear = document.getElementById('memorable-include-year'); // New checkbox

            // --- Data & Character Sets ---
            const charSets = {
                uppercase: 'ABCDEFGHIJKLMNOPQRSTUVWXYZ',
                lowercase: 'abcdefghijklmnopqrstuvwxyz',
                numbers: '0123456789',
                symbols: '!@#$%^&*()_+-=[]{}|;:,.<>?'
            };

            // Characters that are often confused visually
            const similarChars = 'il1o0O';
            // Characters that can be problematic in some contexts (e.g., file paths, command lines)
            const ambiguousChars = '{}[]()/\\\'"`~,;:<>';

            // Expanded word list for memorable passwords, with a focus on Sri Lankan relevance
            const wordList = [
                // General
                'apple', 'banana', 'orange', 'grape', 'lemon', 'peach', 'mango', 'melon', 'berry', 'olive',
                'tiger', 'lion', 'bear', 'wolf', 'fox', 'eagle', 'hawk', 'shark', 'whale', 'dolphin',
                'happy', 'sunny', 'lucky', 'magic', 'dream', 'smile', 'peace', 'brave', 'joyful', 'clever',
                'galaxy', 'comet', 'planet', 'star', 'nebula', 'orbit', 'lunar', 'solar', 'cosmic', 'space',
                'bacon', 'meme', 'doge', 'nyan', 'grumpy', 'troll', 'pog', 'based', 'yeet', 'rickroll',
                'forest', 'mountain', 'river', 'ocean', 'desert', 'valley', 'island', 'volcano', 'glacier', 'canyon',
                'keyboard', 'monitor', 'mouse', 'speaker', 'printer', 'router', 'server', 'firewall', 'database', 'algorithm',
                'bicycle', 'car', 'train', 'plane', 'boat', 'rocket', 'drone', 'scooter', 'skateboard', 'hoverboard',
                'coffee', 'tea', 'water', 'juice', 'soda', 'milk', 'smoothie', 'cocktail', 'espresso', 'latte',
                'summer', 'winter', 'autumn', 'spring', 'holiday', 'vacation', 'weekend', 'sunrise', 'sunset', 'midnight',
                'mystery', 'adventure', 'fantasy', 'thriller', 'comedy', 'drama', 'romance', 'sci-fi', 'horror', 'documentary',
                'guitar', 'piano', 'drums', 'violin', 'trumpet', 'flute', 'saxophone', 'clarinet', 'accordion', 'harmonica',
                'diamond', 'emerald', 'ruby', 'sapphire', 'topaz', 'amethyst', 'opal', 'pearl', 'quartz', 'agate',
                'whisper', 'giggle', 'shout', 'scream', 'mumble', 'chatter', 'murmur', 'humming', 'singing', 'whistle',
                'dragon', 'phoenix', 'griffin', 'unicorn', 'mermaid', 'sphinx', 'centaur', 'goblin', 'ogre', 'fairy',
                'castle', 'dungeon', 'tower', 'village', 'kingdom', 'empire', 'citadel', 'fortress', 'sanctuary', 'labyrinth',
                'ancient', 'futuristic', 'medieval', 'victorian', 'steampunk', 'cyberpunk', 'apocalyptic', 'utopian', 'dystopian', 'magical',
                'journey', 'quest', 'expedition', 'odyssey', 'pilgrimage', 'voyage', 'trek', 'adventure', 'exploration', 'safari',
                'champion', 'hero', 'legend', 'master', 'guardian', 'savior', 'pioneer', 'explorer', 'innovator', 'visionary',
                
                // Sri Lankan specific (English terms)
                'Colombo', 'Kandy', 'Galle', 'Sigiriya', 'Ella', 'NuwaraEliya', 'Jaffna', 'Anuradhapura', 'Polonnaruwa', 'Dambulla',
                'Elephant', 'Leopard', 'Peacock', 'Turtle', 'Monitor', 'Junglefowl', 'Crocodile', 'Kingfisher', 'Coral', 'Lagoon',
                'Curry', 'Cinnamon', 'Tea', 'Coconut', 'Rice', 'Sambol', 'Hoppers', 'Rotti', 'Watalappan', 'Kottu', 'Spices', 'Chillie',
                'Ayubowan', 'Vesak', 'Poya', 'Esala', 'Perehera', 'Temple', 'Stupa', 'Buddha', 'Gemstone', 'Sapphire', 'Emerald', 'Ruby',
                'Beach', 'Ocean', 'Island', 'Hill', 'Waterfall', 'Paddy', 'Plantation', 'Rainforest', 'Wildlife', 'Sanctuary',
                'Cricket', 'LionFlag', 'Ceylon', 'Paradise', 'SpiceIsle', 'TukTuk', 'Sarong', 'Kandyan', 'Drums', 'Masks', 'Handicraft',
                'Sunrise', 'Sunset', 'Monsoon', 'Tropical', 'Warmth', 'Hospitality', 'Culture', 'Heritage', 'Ancient', 'Colonial',
                'Lagoon', 'Reef', 'Surf', 'Diving', 'Snorkel', 'Safari', 'Trekking', 'Pilgrimage', 'Adventure', 'Explore'
            ];

            const leetMap = {
                'a': '4', 'A': '4',
                'e': '3', 'E': '3',
                'g': '6', 'G': '6',
                'i': '1', 'I': '1',
                'o': '0', 'O': '0',
                's': '5', 'S': '5',
                't': '7', 'T': '7'
            };
            
            // --- State ---
            let currentMode = 'random'; // 'random' or 'memorable'

            // --- Functions ---

            /**
             * Returns a cryptographically random character from a given source string or array.
             * Uses window.crypto.getRandomValues for stronger randomness.
             * @param {string|Array<string>} source - The string or array to pick a character from.
             * @returns {string} A random character.
             */
            function getRandomChar(source) {
                if (typeof source === 'string' || Array.isArray(source)) {
                    if (source.length === 0) return '';
                    const randomBytes = new Uint32Array(1);
                    window.crypto.getRandomValues(randomBytes);
                    const randomIndex = randomBytes[0] % source.length;
                    return source[randomIndex];
                }
                return '';
            }

            /**
             * Generates a cryptographically random integer within a specified range (inclusive).
             * @param {number} min - The minimum value.
             * @param {number} max - The maximum value.
             * @returns {number} A random integer.
             */
            function getRandomInt(min, max) {
                min = Math.ceil(min);
                max = Math.floor(max);
                const randomBytes = new Uint32Array(1);
                window.crypto.getRandomValues(randomBytes);
                // Use modulo to ensure it's within the range, then add min
                return Math.floor(randomBytes[0] / (0xFFFFFFFF + 1) * (max - min + 1)) + min;
            }

            /**
             * Shuffles an array in place using the Fisher-Yates (Knuth) algorithm.
             * @param {Array<any>} array - The array to shuffle.
             * @returns {Array<any>} The shuffled array.
             */
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    // Using Math.random for shuffling is generally acceptable for non-cryptographic shuffling
                    const j = Math.floor(Math.random() * (i + 1)); 
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            /**
             * Filters out specified characters from a given character set.
             * @param {string} charSet - The original character set.
             * @param {string} charsToExclude - A string of characters to exclude.
             * @returns {string} The filtered character set.
             */
            function filterChars(charSet, charsToExclude) {
                return Array.from(charSet).filter(char => !charsToExclude.includes(char)).join('');
            }

            /**
             * Generates a random password based on selected character sets and exclusion options.
             * Ensures at least one character from each selected set is included.
             * @param {number} length - The desired length of the password.
             * @returns {string} The generated random password.
             */
            function generateRandomPassword(length) {
                let availableChars = '';
                let password = [];
                let guaranteedChars = [];

                // Determine base available characters
                if (includeUppercase.checked) availableChars += charSets.uppercase;
                if (includeLowercase.checked) availableChars += charSets.lowercase;
                if (includeNumbers.checked) availableChars += charSets.numbers;
                if (includeSymbols.checked) availableChars += charSets.symbols;

                // Apply exclusion filters
                if (excludeSimilar.checked) {
                    availableChars = filterChars(availableChars, similarChars);
                }
                if (excludeAmbiguous.checked) {
                    availableChars = filterChars(availableChars, ambiguousChars);
                }

                // Collect one guaranteed character from each *selected and filtered* type
                if (includeUppercase.checked) {
                    const filteredUppercase = filterChars(charSets.uppercase, (excludeSimilar.checked ? similarChars : '') + (excludeAmbiguous.checked ? ambiguousChars : ''));
                    if (filteredUppercase.length > 0) guaranteedChars.push(getRandomChar(filteredUppercase));
                }
                if (includeLowercase.checked) {
                    const filteredLowercase = filterChars(charSets.lowercase, (excludeSimilar.checked ? similarChars : '') + (excludeAmbiguous.checked ? ambiguousChars : ''));
                    if (filteredLowercase.length > 0) guaranteedChars.push(getRandomChar(filteredLowercase));
                }
                if (includeNumbers.checked) {
                    const filteredNumbers = filterChars(charSets.numbers, (excludeSimilar.checked ? similarChars : '') + (excludeAmbiguous.checked ? ambiguousChars : ''));
                    if (filteredNumbers.length > 0) guaranteedChars.push(getRandomChar(filteredNumbers));
                }
                if (includeSymbols.checked) {
                    const filteredSymbols = filterChars(charSets.symbols, (excludeSimilar.checked ? similarChars : '') + (excludeAmbiguous.checked ? ambiguousChars : ''));
                    if (filteredSymbols.length > 0) guaranteedChars.push(getRandomChar(filteredSymbols));
                }

                // Handle case where no character set is selected or all filtered out
                if (availableChars.length === 0 || guaranteedChars.length === 0) {
                    passwordDisplay.textContent = 'No characters available with current settings!';
                    passwordDisplay.classList.add('text-red-400', 'shake');
                    passwordDisplay.addEventListener('animationend', () => passwordDisplay.classList.remove('shake'), { once: true });
                    return '';
                }
                passwordDisplay.classList.remove('text-red-400'); // Remove error style if present

                // Fill the rest of the password length with random characters from available sets
                const remainingLength = length - guaranteedChars.length;
                for (let i = 0; i < remainingLength; i++) {
                    password.push(getRandomChar(availableChars));
                }

                // Combine guaranteed and random characters, then shuffle
                password = password.concat(guaranteedChars);
                return shuffleArray(password).join('');
            }

            /**
             * Generates a memorable, word-based password to a specific length.
             * Incorporates leetspeak, random numbers, and random capitalization options.
             * @param {number} length - The target length of the password.
             * @returns {string} The generated memorable password.
             */
            function generateMemorablePassword(length) {
                const wordCount = parseInt(wordCountSlider.value, 10);
                // Use a random symbol as a separator between words, filtered by exclusions
                let availableSymbols = charSets.symbols;
                if (excludeSimilar.checked) availableSymbols = filterChars(availableSymbols, similarChars);
                if (excludeAmbiguous.checked) availableSymbols = filterChars(availableSymbols, ambiguousChars);

                if (availableSymbols.length === 0) {
                     passwordDisplay.textContent = 'No symbols available for memorable password!';
                     passwordDisplay.classList.add('text-red-400', 'shake');
                     passwordDisplay.addEventListener('animationend', () => passwordDisplay.classList.remove('shake'), { once: true });
                     return '';
                }
                passwordDisplay.classList.remove('text-red-400');

                const separator = getRandomChar(availableSymbols);
                let passwordParts = [];

                // Build a base password from random words
                for (let i = 0; i < wordCount; i++) {
                    let word = getRandomChar(wordList);
                    
                    if (randomCapitalization.checked) {
                        // Randomly capitalize words (first letter, all caps, or all lowercase)
                        const capMode = getRandomInt(0, 2); // 0: first letter, 1: all caps, 2: all lowercase
                        if (capMode === 0) {
                            word = word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                        } else if (capMode === 1) {
                            word = word.toUpperCase();
                        } else {
                            word = word.toLowerCase();
                        }
                    } else {
                        // Default to capitalizing the first letter if random capitalization is off
                        word = word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
                    }

                    if (useLeetspeak.checked) {
                        // Apply leetspeak transformation
                        word = Array.from(word).map(char => leetMap[char] || char).join('');
                    }
                    passwordParts.push(word);
                }
                
                let password = passwordParts.join(separator);

                // Add a random number if checked
                if (includeMemorableNumber.checked) {
                    const randomNumber = getRandomInt(100, 9999).toString(); // 3 to 4 digit number
                    // Insert the number randomly within the password
                    const insertIndex = getRandomInt(0, password.length);
                    password = password.slice(0, insertIndex) + randomNumber + password.slice(insertIndex);
                }

                // Add a random year if checked
                if (includeMemorableYear.checked) {
                    const currentYear = new Date().getFullYear();
                    const randomYear = getRandomInt(1980, currentYear); // Year from 1980 to current year
                    // Insert the year randomly within the password
                    const insertIndex = getRandomInt(0, password.length);
                    password = password.slice(0, insertIndex) + randomYear + password.slice(insertIndex);
                }


                // Adjust the password to match the target length
                if (password.length > length) {
                    // If it's too long, truncate it.
                    return password.substring(0, length);
                } else {
                    // If it's too short, pad it with numbers and symbols for security.
                    let paddingChars = charSets.numbers + charSets.symbols;
                    // Apply exclusion filters to padding characters
                    if (excludeSimilar.checked) paddingChars = filterChars(paddingChars, similarChars);
                    if (excludeAmbiguous.checked) paddingChars = filterChars(paddingChars, ambiguousChars);

                    if (paddingChars.length === 0 && length > password.length) {
                        // This case should ideally not happen if numbers/symbols are available, but as a safeguard
                        console.warn("Cannot pad password: no valid padding characters available.");
                        return password; // Return as is if padding not possible
                    }

                    let remainingLength = length - password.length;
                    for (let i = 0; i < remainingLength; i++) {
                        password += getRandomChar(paddingChars);
                    }
                    // Shuffle the final result to mix words, numbers, and padding for better security
                    return shuffleArray(Array.from(password)).join('');
                }
            }

            /**
             * Calculates the strength of a given password based ONLY on its length.
             * @param {string} password - The password to evaluate.
             * @returns {{score: number, text: string, class: string}} An object with strength score, descriptive text, and CSS class.
             */
            function calculatePasswordStrength(password) {
                // Handle empty or error passwords
                if (!password || password.startsWith('Select') || password.startsWith('No characters')) {
                    return { score: 0, text: "Strength: N/A", class: "strength-0" };
                }

                const length = password.length;
                let strengthText = "Strength: N/A";
                let strengthClass = "strength-0";

                // Map length to strength categories as per your specification
                if (length >= 0 && length <= 4) { // Adjusted for 0-3 to be "Very Weak"
                    strengthText = "Strength: Very Weak";
                    strengthClass = "strength-0";
                } else if (length >= 5 && length <= 5) {
                    strengthText = "Strength: Weak";
                    strengthClass = "strength-1";
                } else if (length >= 6 && length <= 7) {
                    strengthText = "Strength: Medium";
                    strengthClass = "strength-2";
                } else if (length >= 8 && length <= 10) {
                    strengthText = "Strength: Good";
                    strengthClass = "strength-3";
                } else if (length >= 11 && length <= 15) {
                    strengthText = "Strength: Very Good";
                    strengthClass = "strength-4"; // Using strength-4 color for Very Good
                } else if (length > 15) { // For lengths greater than 15
                    strengthText = "Strength: Ultimate";
                    strengthClass = "strength-4"; // Using strength-4 color for Ultimate
                }

                // The score here is effectively just the length for the purpose of classification
                return { score: length, text: strengthText, class: strengthClass };
            }


            /**
             * Main function to generate the password based on the current mode and settings.
             * Applies an animation to the password display and updates strength indicator.
             */
            function generatePassword() {
                const length = parseInt(lengthSlider.value, 10);
                let password = '';

                if (currentMode === 'random') {
                    password = generateRandomPassword(length);
                } else {
                    password = generateMemorablePassword(length);
                }

                // Update password display and apply animation
                passwordDisplay.classList.remove('password-animate');
                void passwordDisplay.offsetWidth; // Trigger reflow to restart animation
                passwordDisplay.textContent = password;
                passwordDisplay.classList.add('password-animate');

                // Update password strength indicator
                const strength = calculatePasswordStrength(password);
                strengthText.textContent = strength.text;
                strengthBar.className = `strength-bar ${strength.class}`; // Apply new strength class
            }

            /**
             * Handles enabling/disabling of character set checkboxes.
             * Ensures at least one character set is always selected in random mode.
             */
            function updateCharacterCheckboxStates() {
                const checkedCount = characterCheckboxes.filter(cb => cb.checked).length;
                if (checkedCount === 1) {
                    characterCheckboxes.forEach(cb => {
                        if (cb.checked) {
                            cb.disabled = true; // Disable the last checked one
                        }
                    });
                } else {
                    characterCheckboxes.forEach(cb => {
                        cb.disabled = false; // Enable all if more than one are checked
                    });
                }
            }

            /**
             * Copies the generated password to the clipboard using the modern Clipboard API.
             * Provides a fallback for older browsers.
             */
            async function copyToClipboard() {
                const password = passwordDisplay.textContent;
                // Don't copy if there's an error message or no password
                if (!password || password.startsWith('Select') || password.startsWith('No characters')) {
                    // Optionally, provide feedback to the user that there's nothing to copy.
                    return;
                }
                try {
                    await navigator.clipboard.writeText(password);
                    showToast();
                } catch (err) {
                    console.error('Failed to copy password using Clipboard API: ', err);
                    // Fallback for older browsers or if Clipboard API is not available/denied
                    const textarea = document.createElement('textarea');
                    textarea.value = password;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        showToast();
                    } catch (fallbackErr) {
                        console.error('Fallback: Oops, unable to copy', fallbackErr);
                    } finally {
                        document.body.removeChild(textarea);
                    }
                }
            }

            /**
             * Displays a temporary toast notification.
             */
            function showToast() {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }

            /**
             * Sets the password generation mode (Random or Memorable) and updates UI.
             * @param {string} mode - 'random' or 'memorable'.
             */
            function setMode(mode) {
                currentMode = mode;
                const isRandom = mode === 'random';

                // Update button styles
                modeRandomBtn.classList.toggle('bg-indigo-600', isRandom);
                modeRandomBtn.classList.toggle('bg-gray-600', !isRandom);
                modeRandomBtn.classList.toggle('hover:bg-gray-500', !isRandom);
                modeRandomBtn.classList.toggle('active:bg-gray-700', !isRandom);
                modeRandomBtn.classList.toggle('hover:bg-indigo-700', isRandom);
                modeRandomBtn.classList.toggle('active:bg-indigo-800', isRandom);
                
                modeMemorableBtn.classList.toggle('bg-indigo-600', !isRandom);
                modeMemorableBtn.classList.toggle('bg-gray-600', isRandom);
                modeMemorableBtn.classList.toggle('hover:bg-gray-500', isRandom);
                modeMemorableBtn.classList.toggle('active:bg-gray-700', isRandom);
                modeMemorableBtn.classList.toggle('hover:bg-indigo-700', !isRandom);
                modeMemorableBtn.classList.toggle('active:bg-indigo-800', !isRandom);

                // Toggle visibility of options sections
                randomOptions.style.display = isRandom ? 'block' : 'none';
                memorableOptions.style.display = isRandom ? 'none' : 'block';

                // When switching modes, ensure the correct length constraints are applied if needed
                // For now, just regenerate based on the new mode's default/current settings
                generatePassword();
            }

            // --- Event Listeners ---
            lengthSlider.addEventListener('input', (e) => {
                lengthValue.textContent = e.target.value;
                generatePassword(); // Regenerate password as slider moves
            });
            
            wordCountSlider.addEventListener('input', (e) => {
                wordCountValue.textContent = e.target.value;
                generatePassword(); // Regenerate password as slider moves
            });

            // Listen for changes on all character set checkboxes
            characterCheckboxes.forEach(el => {
                el.addEventListener('change', () => {
                    updateCharacterCheckboxStates(); // Update state first
                    generatePassword(); // Then generate new password
                });
            });

            // Listen for changes on exclusion checkboxes
            excludeSimilar.addEventListener('change', generatePassword);
            excludeAmbiguous.addEventListener('change', generatePassword);

            // Listen for changes on memorable options
            useLeetspeak.addEventListener('change', generatePassword);
            includeMemorableNumber.addEventListener('change', generatePassword);
            randomCapitalization.addEventListener('change', generatePassword);
            includeMemorableYear.addEventListener('change', generatePassword); // New event listener for year option

            generateButton.addEventListener('click', generatePassword);
            copyButton.addEventListener('click', copyToClipboard);
            
            modeRandomBtn.addEventListener('click', () => setMode('random'));
            modeMemorableBtn.addEventListener('click', () => setMode('memorable'));

            // --- Initial Setup ---
            updateCharacterCheckboxStates(); // Set initial checkbox states (e.g., disable last checked)
            generatePassword(); // Generate initial password on page load
        });
    </script>
</body>
</html>
